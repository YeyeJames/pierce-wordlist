<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pierce 專用拼字練習 — 離線版 v6</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;background:#0d1224;color:#e8ecff;margin:0;padding-top:80px}
    header{position:fixed;top:0;left:0;right:0;background:#131a35;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,.3)}
    .stats{display:flex;gap:20px;font-weight:700}
    .coin{color:#facc15}
    main{display:flex;gap:20px;padding:20px;max-width:1200px;margin:auto}
    section,aside{background:#1b2345;border:1px solid #2a3560;border-radius:12px;padding:20px;flex:1}
    h2{margin-top:0;color:#7dd3fc}
    .btn{background:#1e2b60;color:white;border:none;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn:hover{background:#293a80}
    input{padding:10px;border-radius:8px;border:1px solid #32406b;background:#0e1530;color:white;width:100%;font-size:18px}
    .store-item{display:flex;justify-content:space-between;align-items:center;margin:8px 0;padding:10px;border:1px dashed #405080;border-radius:10px}
    .price{color:#facc15;font-weight:700}
    .owned{color:#22c55e;font-weight:700}
    select{padding:6px 10px;border-radius:8px;background:#0e1530;color:white;border:1px solid #32406b}
  </style>
</head>
<body>
  <header>
    <div class="stats">
      <div>🪙 金幣：<span id="coins">0</span></div>
      <div>🔥 連續：<span id="streak">0</span></div>
    </div>
    <div>
      <label for="weekSel">週次：</label>
      <select id="weekSel"></select>
      <button id="nextQ" class="btn">下一題</button>
      <button id="listen" class="btn">再聽一次 🔊</button>
    </div>
  </header>
  <main>
    <section>
      <h2>🎧 聽寫練習</h2>
      <input id="answer" placeholder="輸入拼字..." />
      <div style="margin-top:10px;display:flex;gap:10px">
        <button id="submit" class="btn">送出</button>
      </div>
      <div id="feedback" style="margin-top:10px"></div>
      <div id="explain" style="color:#a0a8d8"></div>
      <h3>🎙️ 錄音提示</h3>
      <button id="record" class="btn">錄音</button>
      <button id="playRec" class="btn">播放錄音</button>
      <audio id="audioPlayer" controls hidden></audio>
    </section>

    <aside>
      <h2>🛒 商店</h2>
      <div class="store-item"><span>煙火特效</span><span class="price">30🪙</span><button class="btn buy" data-item="fireworks">購買</button></div>
      <div class="store-item"><span>語音包</span><span class="price">20🪙</span><button class="btn buy" data-item="voicepack">購買</button></div>
      <div class="store-item"><span>酷炫輸入框</span><span class="price">15🪙</span><button class="btn buy" data-item="coolinput">購買</button></div>
      <div class="store-item"><span>✨ 主題顏色包</span><span class="price">25🪙</span><button class="btn buy" data-item="theme">購買</button></div>
      <div class="store-item"><span>🎵 答對音效包</span><span class="price">20🪙</span><button class="btn buy" data-item="sound">購買</button></div>
      <div class="store-item"><span>📜 顯示例句功能</span><span class="price">10🪙</span><button class="btn buy" data-item="sentence">購買</button></div>
      <div class="store-item"><span>🧭 隨機模式切換</span><span class="price">10🪙</span><button class="btn buy" data-item="random">購買</button></div>
    </aside>
  </main>

  <script>
    // IndexedDB for recordings
    let db;
    const request = indexedDB.open('PierceRecordings', 1);
    request.onupgradeneeded = e => {
      db = e.target.result;
      db.createObjectStore('recordings');
    };
    request.onsuccess = e => { db = e.target.result; };

    const audioPlayer = document.getElementById('audioPlayer');
    const recordBtn = document.getElementById('record');
    const playBtn = document.getElementById('playRec');
    let recorder, audioChunks = [], isRecording = false, currentWord = '';

    recordBtn.onclick = async () => {
      if (!isRecording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        audioChunks = [];
        recorder.ondataavailable = e => audioChunks.push(e.data);
        recorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const tx = db.transaction('recordings', 'readwrite');
          tx.objectStore('recordings').put(blob, currentWord);
          alert('✅ 已儲存錄音');
          const url = URL.createObjectURL(blob);
          audioPlayer.src = url;
          audioPlayer.hidden = false;
          audioPlayer.play();
          audioPlayer.onended = () => alert('✔️ 播放結束');
        };
        recorder.start();
        recordBtn.textContent = '停止錄音';
        isRecording = true;
      } else {
        recorder.stop();
        recordBtn.textContent = '錄音';
        isRecording = false;
      }
    };

    playBtn.onclick = () => {
      if (!currentWord) { alert('請先出題再錄音'); return; }
      const tx = db.transaction('recordings', 'readonly');
      const req = tx.objectStore('recordings').get(currentWord);
      req.onsuccess = e => {
        const blob = e.target.result;
        if (blob) {
          const url = URL.createObjectURL(blob);
          audioPlayer.src = url;
          audioPlayer.hidden = false;
          audioPlayer.play();
          audioPlayer.onended = () => alert('✔️ 播放結束');
        } else {
          alert('尚未錄音');
        }
      };
    };
  </script>
</body>
</html>